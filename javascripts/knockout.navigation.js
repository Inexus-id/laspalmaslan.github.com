// knockout-navigation
// (c) Johnny L. Rancho - https://github.com/jlrancho/knockout-navigation
// License: MIT (http://www.opensource.org/licenses/mit-license.php)
(function(){function s(){return r++ +""+(new Date).getTime()}String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var e=History.getIdByUrl;History.getIdByUrl=function(t){return e(decodeURI(t))};var t=ko.navigation={},n=window,r=0,i=!1;t.parseQueryString=function(e){if(e.indexOf("?")<0)return{};var t=e.substring(e.lastIndexOf("?")+1),n={},r=t.split("&");for(var i=0,s=r.length;i<s;i++){var o=r[i],u=o.split("=");if(u.length===2&&u[0]!="s"&&u[0]!="_suid"){var a=decodeURIComponent(u[1]);isNaN(a)?isNaN(new Date(a))?a.toLowerCase()==="true"?n[u[0]]=!0:a.toLowerCase()==="false"?n[u[0]]=!1:n[u[0]]=a:n[u[0]]=new Date(a):n[u[0]]=Number(a)}}return n},t.formatQueryString=function(e){var t="";for(var n in e)if(e.hasOwnProperty(n))if(e[n]instanceof Date){var r=e[n];t+="&"+n+"="+(r.getMonth()+1)+"/"+r.getDate()+"/"+r.getFullYear()}else typeof e[n]in{"boolean":1,number:1,string:1}&&(t+="&"+n+"="+encodeURIComponent(e[n]));return t},t.setNamespace=function(e){n=e},t.getTypeName=function(e){if(e.typeName)return e.typeName;if(e.constructor.typeName)return e.constructor.typeName;for(name in n)if(n[name]===e.constructor)return e.constructor.typeName=name,name;return null},t.createViewModel=function(e,t){if(!e||!(e in n))return null;try{var r=new n[e](t);return r.bookmarkable?r:null}catch(i){return null}},t.typeToViewName=function(e){var t=e.replace("Model","");return t},t.resolveView=function(e){if(!e)return null;if(e.viewName)return e.viewName;var n=t.getTypeName(e);if(!n)throw new Error("In order resolve a view from a view model instance the object must either have a constructor function defined on the namespace specified with ko.navigation.setNamespace(ns) or must provide a viewName property.");return t.typeToViewName(n)},t.transition={"default":function(e,t,n){e&&(e.style.display="none"),t.style.display="block"}},t.NavigationModel=function(e){var t=this,e=e||{};this.navigationStack=ko.observableArray([]),this.currentItem=ko.observable(),e.defaultViewModel&&(t.navigationStack.push(e.defaultViewModel),t.currentItem(e.defaultViewModel)),this.canGoBack=ko.computed(function(){var e=t.navigationStack();return e.length>0&&e[0]!=t.currentItem()}),this.canGoForward=ko.computed(function(){var e=t.navigationStack();return e.length>0&&e[e.length-1]!=t.currentItem()}),this.back=function(){if(t.canGoBack()){var e=t.navigationStack.indexOf(t.currentItem()),n=t.navigationStack()[e-1];t.currentItem(n)}},this.forward=function(){if(t.canGoForward()){var e=t.navigationStack.indexOf(t.currentItem()),n=t.navigationStack()[e+1];t.currentItem(n)}},this.navigateTo=function(e){var n=t.currentItem(),r=t.navigationStack();if(n&&r.length>0){var i=r[r.length-1];if(n!==i){var s=t.navigationStack.indexOf(n);r.length=s+1}}t.navigationStack.push(e),t.currentItem(e)}},t.ShellNavigationModel=function(e){if(i)throw new Error("There can only be one instance of the ShellNavigationModel.");i=!0;var n=this,e=e||{},r=e.expiredViewModel;this.navigationStack=ko.observableArray([]);var o=ko.observable(),u=ko.observable();this.currentItem=ko.dependentObservable(function(){return o()||u()});var a=s(),f=History.emulated.pushState?"?s="+a:"?",l=t.parseQueryString(document.URL),c=t.createViewModel(l.screen,l);if(c){var h=t.formatQueryString(l);History.emulated.pushState||(h=h.substr(1)),f+=h}else e.defaultViewModel&&(c=typeof e.defaultViewModel=="function"?e.defaultViewModel():e.defaultViewModel);c&&(c.stateId=a,n.navigationStack.push(c),u(c),History.replaceState({stateId:a},null,f)),this.canGoBack=ko.computed(function(){var e=n.navigationStack();return e.length>0&&e[0]!=u()}),this.canGoForward=ko.computed(function(){var e=n.navigationStack();return e.length>0&&e[e.length-1]!=u()}),this.back=function(){n.canGoBack()&&History.back()},this.forward=function(){n.canGoForward()&&History.forward()},this.navigateTo=function(r){var i=s(),a=History.emulated.pushState?"?s="+i:"?";if(r.bookmarkable){var f=t.getTypeName(r);if(!f)throw new Error("Can't determine the typeName for view model.");a+=(History.emulated.pushState?"&":"")+"screen="+f,r.parameters&&(a+=t.formatQueryString(r.parameters))}if(u()){var l=n.navigationStack(),c=l[l.length-1];if(u()!==c){var h=n.navigationStack.indexOf(u());l.length=h+1}o()&&History.replaceState({stateId:u().stateId},null,a)}if(e.maxStackSize&&n.navigationStack().length>=e.maxStackSize){var p=n.navigationStack().length-e.maxStackSize+1;n.navigationStack().splice(0,p)}r.stateId=i,n.navigationStack.push(r),History.pushState({stateId:r.stateId},null,a)},History.Adapter.bind(window,"statechange",function(){var e=History.getState().data.stateId,t=ko.utils.arrayFirst(n.navigationStack(),function(t){return t.stateId&&t.stateId==e});t&&t.expired&&(n.navigationStack.remove(t),t=null),t?(u(t),o(null)):r&&o(r)})};var o="__ko_autoResolve__",u=ko.bindingHandlers.template;ko.bindingHandlers.template={init:function(e,t){var n=ko.utils.unwrapObservable(t()),r=typeof n!="string"&&!n.name&&e.nodeType==1&&e.innerHTML.trim()=="";return ko.utils.domData.set(e,o,r),u.init(e,t)},update:function(e,n,r,i,s){var a=function(){var r=ko.utils.unwrapObservable(n()),i=ko.utils.domData.get(e,o);return i?{name:t.resolveView,data:r}:r};u.update(e,a,r,i,s)}},ko.bindingHandlers.navigation={init:function(e,t){var n=ko.utils.unwrapObservable(t());if(!n.currentItem||!n.navigationStack)throw new Error("The navigation binding expects an object with 'currentItem' and 'navigationStack' properties passed directly or in the data property of a config object.");if(e.nodeType==1&&e.innerHTML.trim()!=""){var r=e.innerHTML.trim(),i=ko.utils.parseHtmlFragment(r);if(i.length!=1)throw new Error("The navigation item layout template should have one and only one top level element.");return e.innerHTML=r,ko.bindingHandlers.template.init(e,t)}var s='<div data-bind="template: $data" style="display: none"></div>';return(new ko.templateSources.anonymousTemplate(e)).text(s),{controlsDescendantBindings:!0}},update:function(e,t,n,r,i){var s=function(){var r=t(),i=n(),s=i.transitionKey||"default",o=null,u=null,a=ko.observableArray();r.currentItem.subscribe(function(e){r.navigationStack.indexOf(e)==-1&&a.push(e)});var f=ko.dependentObservable(function(){var e=r.navigationStack().concat(a());return ko.utils.arrayGetDistinctValues(e)});return{foreach:f,templateEngine:ko.nativeTemplateEngine.instance,name:e,afterRender:function(e,t){var n=e[0];ko.dependentObservable({read:function(){if(r.currentItem()===t&&u!==t){var e,i=a.indexOf(u)!=-1,f=a.indexOf(t)!=-1;if(o===null)e="Initial";else if(i&&f)e="Transient";else if(i)e="FromTransient";else if(f)e="ToTransient";else{var l=r.navigationStack.indexOf(u),c=r.navigationStack.indexOf(t),h=c-l;h==1?e="Forward":h==-1?e="Back":h>1?e="JumpForward":h<-1&&(e="JumpBack")}ko.navigation.transition[s](o,n,e);var p=u;u=t,o=n,i&&a.remove(p)}},disposeWhenNodeIsRemoved:n})}}};return ko.bindingHandlers.template.update(e,s,n,r,i)}}})();