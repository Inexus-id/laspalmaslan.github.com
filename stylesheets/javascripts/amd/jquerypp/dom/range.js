/*
* jQuery++ - 1.0.0 (2012-11-23)
* http://jquerypp.com
* Copyright (c) 2012 Bitovi
* Licensed MIT
*/
define(["jquery","jquerypp/dom/compare"],function(e){e.fn.range=function(){return e.Range(this[0])};var t=function(e){return e.replace(/([a-z])([a-z]+)/gi,function(e,t,n){return t+n.toLowerCase()}).replace(/_/g,"")},n=function(e){return e.replace(/^([a-z]+)_TO_([a-z]+)/i,function(e,t,n){return n+"_TO_"+t})},r=function(e){return e?e.ownerDocument.defaultView||e.ownerDocument.parentWindow:window},i=function(e,t,n){if(n-t==1)return},s={};e.Range=function(t){if(this.constructor!==e.Range)return new e.Range(t);t&&t.jquery&&(t=t[0]),!t||t.nodeType?(this.win=r(t),this.win.document.createRange?this.range=this.win.document.createRange():this.win&&this.win.document.body&&this.win.document.body.createTextRange&&(this.range=this.win.document.body.createTextRange()),t&&this.select(t)):t.clientX!=null||t.pageX!=null||t.left!=null?this.moveToPoint(t):t.originalEvent&&t.originalEvent.touches&&t.originalEvent.touches.length?this.moveToPoint(t.originalEvent.touches[0]):t.originalEvent&&t.originalEvent.changedTouches&&t.originalEvent.changedTouches.length?this.moveToPoint(t.originalEvent.changedTouches[0]):this.range=t},e.Range.current=function(t){var n=r(t),i;return n.getSelection?(i=n.getSelection(),new e.Range(i.rangeCount?i.getRangeAt(0):n.document.createRange())):new e.Range(n.document.selection.createRange())},e.extend(e.Range.prototype,{moveToPoint:function(t){var n=t.clientX,r=t.clientY;if(!n){var i=g();n=(t.pageX||t.left||0)-i.left,r=(t.pageY||t.top||0)-i.top}if(s.moveToPoint)return this.range=e.Range().range,this.range.moveToPoint(n,r),this;var u=document.elementFromPoint(n,r);for(var a=0;a<u.childNodes.length;a++){var f=u.childNodes[a];if(f.nodeType===3||f.nodeType===4){var l=e.Range(f),c=l.toString().length;for(var h=1;h<c+1;h++){var p=l.end(h).rect();if(p.left<=n&&p.left+p.width>=n&&p.top<=r&&p.top+p.height>=r)return l.start(h-1),this.range=l.range,this}}}var d;o(u.childNodes,function(n){var r=e.Range(n);if(r.rect().top>t.clientY)return!1;d=r}),d?(d.start(d.toString().length),this.range=d.range):this.range=e.Range(u).range},window:function(){return this.win||window},overlaps:function(t){t.nodeType&&(t=e.Range(t).select(t));var n=this.compare("START_TO_START",t),r=this.compare("END_TO_END",t);return n<=0&&r>=0?!0:n>=0&&this.compare("START_TO_END",t)<=0?!0:this.compare("END_TO_START",t)>=0&&r<=0?!0:!1},collapse:function(e){return this.range.collapse(e===undefined?!0:e),this},toString:function(){return typeof this.range.text=="string"?this.range.text:this.range.toString()},start:function(t){if(t===undefined){if(this.range.startContainer)return{container:this.range.startContainer,offset:this.range.startOffset};var n=this.clone().collapse().parent(),r=e.Range(n).select(n).collapse();return r.move("END_TO_START",this),{container:n,offset:r.toString().length}}if(this.range.setStart)if(typeof t=="number")this.range.setStart(this.range.startContainer,t);else if(typeof t=="string"){var i=c(this.range.startContainer,this.range.startOffset,parseInt(t,10));this.range.setStart(i.node,i.offset)}else this.range.setStart(t.container,t.offset);else if(typeof t=="string")this.range.moveStart("character",parseInt(t,10));else{var s=this.start().container,o;typeof t=="number"?o=t:(s=t.container,o=t.offset);var u=e.Range(s).collapse();u.range.move(o),this.move("START_TO_START",u)}return this},end:function(t){if(t===undefined){if(this.range.startContainer)return{container:this.range.endContainer,offset:this.range.endOffset};var n=this.clone().collapse(!1).parent(),r=e.Range(n).select(n).collapse();return r.move("END_TO_END",this),{container:n,offset:r.toString().length}}if(this.range.setEnd)if(typeof t=="number")this.range.setEnd(this.range.endContainer,t);else if(typeof t=="string"){var i=c(this.range.endContainer,this.range.endOffset,parseInt(t,10));this.range.setEnd(i.node,i.offset)}else this.range.setEnd(t.container,t.offset);else if(typeof t=="string")this.range.moveEnd("character",parseInt(t,10));else{var s=this.end().container,o;typeof t=="number"?o=t:(s=t.container,o=t.offset);var u=e.Range(s).collapse();u.range.move(o),this.move("END_TO_START",u)}return this},parent:function(){if(this.range.commonAncestorContainer)return this.range.commonAncestorContainer;var t=this.range.parentElement(),n=this.range;return o(t.childNodes,function(r){if(e.Range(r).range.inRange(n))return t=r,!1}),t},rect:function(t){var n=this.range.getBoundingClientRect();!n.height&&!n.width&&(n=this.range.getClientRects()[0]);if(t==="page"){var r=g();n=e.extend({},n),n.top+=r.top,n.left+=r.left}return n},rects:function(t){var n=e.map(e.makeArray(this.range.getClientRects()).sort(function(e,t){return t.width*t.height-e.width*e.height}),function(t){return e.extend({},t)}),r=0,i,s=n.length;while(r<n.length){var o=n[r],u=!1;i=r+1;while(i<n.length)if(m(o,n[i])){if(!!n[i].width){u=n[i];break}n.splice(i,1)}else i++;u?n.splice(r,1):r++}if(t=="page"){var a=g();return e.each(n,function(e,t){t.top+=a.top,t.left+=a.left})}return n}}),function(){var r=e.Range.prototype,i=e.Range().range;r.compare=i.compareBoundaryPoints?function(e,t){return this.range.compareBoundaryPoints(this.window().Range[n(e)],t.range)}:function(e,n){return this.range.compareEndPoints(t(e),n.range)},r.move=i.setStart?function(e,t){var n=t.range;switch(e){case"START_TO_END":this.range.setStart(n.endContainer,n.endOffset);break;case"START_TO_START":this.range.setStart(n.startContainer,n.startOffset);break;case"END_TO_END":this.range.setEnd(n.endContainer,n.endOffset);break;case"END_TO_START":this.range.setEnd(n.startContainer,n.startOffset)}return this}:function(e,n){return this.range.setEndPoint(t(e),n.range),this};var s=i.cloneRange?"cloneRange":"duplicate",u=i.selectNodeContents?"selectNodeContents":"moveToElementText";r.clone=function(){return e.Range(this.range[s]())},r.select=i.selectNodeContents?function(e){if(!e){var t=this.window().getSelection();t.removeAllRanges(),t.addRange(this.range)}else this.range.selectNodeContents(e);return this}:function(e){if(!e)this.range.select();else if(e.nodeType===3){var t=e.parentNode,n=0,r;o(t.childNodes,function(t){if(t===e)return r=n+t.nodeValue.length,!1;n+=t.nodeValue.length}),this.range.moveToElementText(t),this.range.moveEnd("character",r-this.range.text.length),this.range.moveStart("character",n)}else this.range.moveToElementText(e);return this}}();var o=function(e,t){var n,r;for(var i=0;e[i];i++){n=e[i];if(n.nodeType===3||n.nodeType===4){if(t(n)===!1)return!1}else if(n.nodeType!==8&&o(n.childNodes,t)===!1)return!1}},u=function(e){return e.nodeType===3||e.nodeType===4},a=function(e,t){return function(n,r){if(n[e]&&!r)return u(n[e])?n[e]:arguments.callee(n[e]);if(n[t])return u(n[t])?n[t]:arguments.callee(n[t]);if(n.parentNode)return arguments.callee(n.parentNode,!0)}},f=a("firstChild","nextSibling"),l=a("lastChild","previousSibling"),c=function(e,t,n){return u(e)?h(e,t+n):e.childNodes[t]?h(e.childNodes[t],n):h(e.lastChild,n,!0)},h=function(e,t){var n=t<0?l:f;t=Math.abs(t),u(e)||(e=n(e));while(e&&t>=e.nodeValue.length)hasMany=t-e.nodeValue.length,e=n(e);return{node:e,offset:n===f?t:e.nodeValue.length-t}},p,d=function(e){return p==null&&(p="isElementContentWhitespace"in e),p?e.isElementContentWhitespace:e.nodeType===3&&""==e.data.trim()},v=function(e,t){return e.left<=t.clientX&&e.left+e.width>=t.clientX&&e.top<=t.clientY&&e.top+e.height>=t.clientY},m=function(e,t){return v(e,{clientX:t.left,clientY:t.top})&&v(e,{clientX:t.left+t.width,clientY:t.top})&&v(e,{clientX:t.left,clientY:t.top+t.height})&&v(e,{clientX:t.left+t.width,clientY:t.top+t.height})},g=function(e){var e=e||window;return doc=e.document.documentElement,body=e.document.body,{left:(doc&&doc.scrollLeft||body&&body.scrollLeft||0)+(doc.clientLeft||0),top:(doc&&doc.scrollTop||body&&body.scrollTop||0)+(doc.clientTop||0)}};return s.moveToPoint=!!e.Range().range.moveToPoint,e});